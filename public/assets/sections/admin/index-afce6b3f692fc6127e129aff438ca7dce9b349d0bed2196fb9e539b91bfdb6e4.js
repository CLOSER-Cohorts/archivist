(function(){var e;(e=angular.module("archivist.admin",["templates","ngRoute","archivist.data_manager","archivist.flash"])).config(["$routeProvider",function(e){return e.when("/admin",{templateUrl:"partials/admin/index.html",controller:"AdminDashController"}).when("/admin/instruments",{templateUrl:"partials/admin/instruments.html",controller:"AdminInstrumentsController"}).when("/admin/datasets",{templateUrl:"partials/admin/datasets.html",controller:"AdminDatasetsController"}).when("/admin/users",{templateUrl:"partials/admin/users.html",controller:"AdminUsersController"}).when("/admin/import",{templateUrl:"partials/admin/import.html",controller:"AdminImportController"}).when("/admin/export",{templateUrl:"partials/admin/export.html",controller:"AdminExportController"})}]),e.controller("AdminDashController",["$scope","DataManager",function(e,n){return e.counts=n.getApplicationStats()}]),e.controller("AdminUsersController",["$scope","DataManager","Flash",function(e,n,t){return n.getUsers(),e.groups=n.Data.Groups,e.reset=function(){return e.users=[],e.current=null,e.mode=!1,e.editing=!1},e.reset(),e.selectGroup=function(n){return e.users=n.users,e.current=n,e.mode="group",e.editing=!1},e.selectUser=function(n){return e.current=n,e.mode="user",e.editing=!1},e.newGroup=function(){return e.original=null,e.current=new n.Auth.Groups.resource,e.current.study=[{label:""}],e.mode="group",e.editing=!0},e.newUser=function(){return e.original=null,e.current=new n.Auth.Users.resource,e.mode="user",e.users=[],e.editing=!0},e.addStudy=function(){return e.current.study.push({label:""})},e.edit=function(){return e.original=e.current,e.current=null,e.current=angular.copy(e.original),e.editing=!0},e.cancel=function(){return null!=e.original?e.current=e.original:(e.current=null,e.mode=!1),e.editing=!1},e.save=function(){return console.log(e),null!=e.original?angular.copy(e.current,e.original):("group"===e.mode?e.groups.push(e.current):(n.Data.Users.push(e.current),n.GroupResolver.resolve()),e.original=e.current),e.original.save({},function(){return e.editing=!1},function(){return e.original=null,t.add("danger","Could not save "+e.mode+".")})},e.reset_password=function(){return e.current.$reset_password()},e.lock=function(){return e.current.$lock()},e["delete"]=function(){var n,t;return n=e[e.mode+"s"],t=n.indexOf(e.current),n[t].$delete({},function(){return n.splice(t,1),e.reset()})},e.only_group_check=function(){if(1===e.groups.length)return e.selectGroup(e.groups[e.groups.length-1])},e.groups.$promise.then(function(){return e.only_group_check()})}]),e.controller("AdminInstrumentsController",["$scope","DataManager","Flash","$http","AdminMappingImportsFactory",function(e,n,t,r,o){return e.instruments=n.Instruments.query(),e.pageSize=24,e.currentPage=1,e.confirmation={prefix:""},e.mapping={},e.prepareCopy=function(n){return e.original=e.instruments.select_resource_by_id(n),e.copiedInstrument={},e.copiedInstrument.new_study=e.original.study,e.copiedInstrument.new_agency=e.original.agency,e.copiedInstrument.new_version=e.original.version},e.copy=function(){return e.copiedInstrument=e.original.$copy(e.copiedInstrument,function(){return t.add("success","Instrument copied successfully")},function(e){return t.add("danger","Instrument failed to copy - "+e.message)})},e.prepareDelete=function(n){return e.instrument=e.instruments.select_resource_by_id(n)},e["delete"]=function(){return e.confirmation.prefix===e.instrument.prefix?e.instrument.$delete({},function(){return n.Data={},e.instruments=n.Instruments.requery(),t.add("success","Instrument deleted successfully")},function(e){return console.error(e),t.add("danger","Failed to delete instrument - "+e.message)}):t.add("danger","The prefixes did not match. The instrument was not deleted."),e.confirmation.prefix=""},e.prepareNew=function(){return e.newInstrument=new n.Instruments.resource},e["new"]=function(){return e.newInstrument.$create({},function(){return t.add("success","New instrument created successfully")},function(e){return t.add("danger","Failed to create new instrument - "+e.message)}),e.instruments.push(e.newInstrument)},e.cleanInputImport=function(){if(e.mapping.files)return e.mapping.files=void 0},e.clearCache=function(n){return e.instruments.select_resource_by_id(n).$clear_cache()},e.prepareImport=function(n,t){return e.id=t,e.modal={},e.modal.title=n,e.modal.msgFileType="Q-V and T-Q",e.modal.fileTypes=[{value:"qvmapping",label:"Q-V Mapping"},{value:"topicq",label:"T-Q Mapping"}]},e["import"]=function(){return o["import"](e.mapping.files,e.mapping.type,"POST","/instruments/"+e.id+"/imports.json").then(function(e){return 200===e.status?t.add("success","File imported."):t.add("danger","Something went wrong, please import the file again.")},function(){return t.add("danger","Something went wrong, please import the file again.")})}}]),e.controller("AdminDatasetsController",["$scope","DataManager","Flash","$http","AdminMappingImportsFactory",function(e,n,t,r,o){return e.datasets=n.getDatasets(),e.pageSize=24,e.currentPage=1,e.mapping={},e.prepareImport=function(n,t){return e.id=t,e.modal={},e.modal.title=n,e.modal.msgFileType="T-V and DV",e.modal.fileTypes=[{value:"topicv",label:"T-V Mapping"},{value:"dv",label:"DV Mapping"}]},e["import"]=function(){return o["import"](e.mapping.files,e.mapping.type,"POST","/datasets/"+e.id+"/imports.json").then(function(e){return 200===e.status?t.add("success","File imported."):t.add("danger","Something went wrong, please import the file again.")},function(e){return console.log(e),t.add("danger","Something went wrong, please import the file again.")})},e.prepareDelete=function(n){return e.dataset=e.datasets.select_resource_by_id(n)},e["delete"]=function(){return e.dataset.$delete({},function(){return n.Data={},e.datasets=n.Dataset.requery(),t.add("success","Dataset deleted successfully")},function(e){return console.error(e),t.add("danger","Failed to delete dataset - "+e.message)})}}]),e.controller("AdminImportController",["$scope","$http","Flash",function(e,n,t){return e.files=[],e.options={question_grids:!0},e.uploadInstrumentImport=function(){var r,o,i,a,s;for(e.publish_flash(),r=new FormData,angular.forEach(e.files,function(e){return r.append("files[]",e)}),o=0,a=(s=["question_grids","instrument_prefix","instrument_agency","instrument_study"]).length;o<a;o++)i=s[o],null!=e.options[i]&&r.set(i,e.options[i]);if(e.options)return n({method:"POST",url:"/admin/import/instruments",data:r,transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(){return t.add("success","Instrument imported.")}).error(function(e){return t.add("danger","Instrument failed to import - "+e.message)})},e.uploadDatasetImport=function(){var r;return e.publish_flash(),r=new FormData,angular.forEach(e.files,function(e){return r.append("files[]",e)}),n({method:"POST",url:"/admin/import/datasets",data:r,transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(){return t.add("success","Dataset imported.")}).error(function(e){return t.add("danger","Dataset failed to import - "+e.message)})}}]),e.controller("AdminExportController",["$scope","$http","DataManager",function(e,n,t){return e.instruments=t.Instruments.query({},function(e){return angular.forEach(e,function(e){return e.can_export=Date.parse(e.export_time)<Date.parse(e.last_edited_time)||null===e.export_time,e.has_export=null!==e.export_url})}),e.pageSize=24,e.currentPage=1,console.log(e),e["export"]=function(e){return n.get("/instruments/"+e.id.toString()+"/export.json")}}]),e.factory("AdminMappingImportsFactory",["$http","$q",function(e,n){var t;return(t={})["import"]=function(t,r,o,i){var a,s,u;for(s=0,(u={}).imports=[];s<t.length;)a={file:t[s].base64,type:r[s]},u.imports.push(a),s++;return e({method:o,url:i,data:JSON.stringify(u)}).then(function(e){return console.log("imported"),console.log(e),e},function(e){return console.log(e),n.reject(e)})},t}])}).call(this);