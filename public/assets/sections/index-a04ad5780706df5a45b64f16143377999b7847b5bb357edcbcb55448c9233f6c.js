(function(){var e;(e=angular.module("archivist.admin",["templates","ngRoute","archivist.data_manager","archivist.flash"])).config(["$routeProvider",function(e){return e.when("/admin",{templateUrl:"partials/admin/index.html",controller:"AdminDashController"}).when("/admin/instruments",{templateUrl:"partials/admin/instruments.html",controller:"AdminInstrumentsController"}).when("/admin/datasets",{templateUrl:"partials/admin/datasets.html",controller:"AdminDatasetsController"}).when("/admin/users",{templateUrl:"partials/admin/users.html",controller:"AdminUsersController"}).when("/admin/import",{templateUrl:"partials/admin/import.html",controller:"AdminImportController"}).when("/admin/export",{templateUrl:"partials/admin/export.html",controller:"AdminExportController"})}]),e.controller("AdminDashController",["$scope","DataManager",function(e,t){return e.counts=t.getApplicationStats()}]),e.controller("AdminUsersController",["$scope","DataManager","Flash",function(e,t,n){return t.getUsers(),e.groups=t.Data.Groups,e.reset=function(){return e.users=[],e.current=null,e.mode=!1,e.editing=!1},e.reset(),e.selectGroup=function(t){return e.users=t.users,e.current=t,e.mode="group",e.editing=!1},e.selectUser=function(t){return e.current=t,e.mode="user",e.editing=!1},e.newGroup=function(){return e.original=null,e.current=new t.Auth.Groups.resource,e.current.study=[{label:""}],e.mode="group",e.editing=!0},e.newUser=function(){return e.original=null,e.current=new t.Auth.Users.resource,e.mode="user",e.users=[],e.editing=!0},e.addStudy=function(){return e.current.study.push({label:""})},e.edit=function(){return e.original=e.current,e.current=null,e.current=angular.copy(e.original),e.editing=!0},e.cancel=function(){return null!=e.original?e.current=e.original:(e.current=null,e.mode=!1),e.editing=!1},e.save=function(){return console.log(e),null!=e.original?angular.copy(e.current,e.original):("group"===e.mode?e.groups.push(e.current):(t.Data.Users.push(e.current),t.GroupResolver.resolve()),e.original=e.current),e.original.save({},function(){return e.editing=!1},function(){return e.original=null,n.add("danger","Could not save "+e.mode+".")})},e.reset_password=function(){return e.current.$reset_password()},e.lock=function(){return e.current.$lock()},e["delete"]=function(){var t,n;return t=e[e.mode+"s"],n=t.indexOf(e.current),t[n].$delete({},function(){return t.splice(n,1),e.reset()})},e.only_group_check=function(){if(1===e.groups.length)return e.selectGroup(e.groups[e.groups.length-1])},e.groups.$promise.then(function(){return e.only_group_check()})}]),e.controller("AdminInstrumentsController",["$scope","DataManager","Flash","$http","AdminMappingImportsFactory",function(e,t,n,r,i){return e.instruments=t.Instruments.query(),e.pageSize=24,e.currentPage=1,e.confirmation={prefix:""},e.mapping={},e.prepareCopy=function(t){return e.original=e.instruments.select_resource_by_id(t),e.copiedInstrument={},e.copiedInstrument.new_study=e.original.study,e.copiedInstrument.new_agency=e.original.agency,e.copiedInstrument.new_version=e.original.version},e.copy=function(){return e.copiedInstrument=e.original.$copy(e.copiedInstrument,function(){return n.add("success","Instrument copied successfully")},function(e){return n.add("danger","Instrument failed to copy - "+e.message)})},e.prepareDelete=function(t){return e.instrument=e.instruments.select_resource_by_id(t)},e["delete"]=function(){return e.confirmation.prefix===e.instrument.prefix?e.instrument.$delete({},function(){return t.Data={},e.instruments=t.Instruments.requery(),n.add("success","Instrument deleted successfully")},function(e){return console.error(e),n.add("danger","Failed to delete instrument - "+e.message)}):n.add("danger","The prefixes did not match. The instrument was not deleted."),e.confirmation.prefix=""},e.prepareNew=function(){return e.newInstrument=new t.Instruments.resource},e["new"]=function(){return e.newInstrument.$create({},function(){return n.add("success","New instrument created successfully")},function(e){return n.add("danger","Failed to create new instrument - "+e.message)}),e.instruments.push(e.newInstrument)},e.cleanInputImport=function(){if(e.mapping.files)return e.mapping.files=void 0},e.clearCache=function(t){return e.instruments.select_resource_by_id(t).$clear_cache()},e.prepareImport=function(t,n){return e.id=n,e.modal={},e.modal.title=t,e.modal.msgFileType="Q-V and T-Q",e.modal.fileTypes=[{value:"qvmapping",label:"Q-V Mapping"},{value:"topicq",label:"T-Q Mapping"}]},e["import"]=function(){return i["import"](e.mapping.files,e.mapping.type,"POST","/instruments/"+e.id+"/imports.json").then(function(e){return 200===e.status?n.add("success","File imported."):n.add("danger","Something went wrong, please import the file again.")},function(){return n.add("danger","Something went wrong, please import the file again.")})}}]),e.controller("AdminDatasetsController",["$scope","DataManager","Flash","$http","AdminMappingImportsFactory",function(e,t,n,r,i){return e.datasets=t.getDatasets(),e.pageSize=24,e.currentPage=1,e.mapping={},e.prepareImport=function(t,n){return e.id=n,e.modal={},e.modal.title=t,e.modal.msgFileType="T-V and DV",e.modal.fileTypes=[{value:"topicv",label:"T-V Mapping"},{value:"dv",label:"DV Mapping"}]},e["import"]=function(){return i["import"](e.mapping.files,e.mapping.type,"POST","/datasets/"+e.id+"/imports.json").then(function(e){return 200===e.status?n.add("success","File imported."):n.add("danger","Something went wrong, please import the file again.")},function(e){return console.log(e),n.add("danger","Something went wrong, please import the file again.")})},e.prepareDelete=function(t){return e.dataset=e.datasets.select_resource_by_id(t)},e["delete"]=function(){return e.dataset.$delete({},function(){return t.Data={},e.datasets=t.Dataset.requery(),n.add("success","Dataset deleted successfully")},function(e){return console.error(e),n.add("danger","Failed to delete dataset - "+e.message)})}}]),e.controller("AdminImportController",["$scope","$http","Flash",function(e,t,n){return e.files=[],e.options={question_grids:!0},e.uploadInstrumentImport=function(){var r,i,s,o,a;for(e.publish_flash(),r=new FormData,angular.forEach(e.files,function(e){return r.append("files[]",e)}),i=0,o=(a=["question_grids","instrument_prefix","instrument_agency","instrument_study"]).length;i<o;i++)s=a[i],null!=e.options[s]&&r.set(s,e.options[s]);if(e.options)return t({method:"POST",url:"/admin/import/instruments",data:r,transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(){return n.add("success","Instrument imported.")}).error(function(e){return n.add("danger","Instrument failed to import - "+e.message)})},e.uploadDatasetImport=function(){var r;return e.publish_flash(),r=new FormData,angular.forEach(e.files,function(e){return r.append("files[]",e)}),t({method:"POST",url:"/admin/import/datasets",data:r,transformRequest:angular.identity,headers:{"Content-Type":void 0}}).success(function(){return n.add("success","Dataset imported.")}).error(function(e){return n.add("danger","Dataset failed to import - "+e.message)})}}]),e.controller("AdminExportController",["$scope","$http","DataManager",function(e,t,n){return e.instruments=n.Instruments.query({},function(e){return angular.forEach(e,function(e){return e.can_export=Date.parse(e.export_time)<Date.parse(e.last_edited_time)||null===e.export_time,e.has_export=null!==e.export_url})}),e.pageSize=24,e.currentPage=1,console.log(e),e["export"]=function(e){return t.get("/instruments/"+e.id.toString()+"/export.json")}}]),e.factory("AdminMappingImportsFactory",["$http","$q",function(e,t){var n;return(n={})["import"]=function(n,r,i,s){var o,a,u;for(a=0,(u={}).imports=[];a<n.length;)o={file:n[a].base64,type:r[a]},u.imports.push(o),a++;return e({method:i,url:s,data:JSON.stringify(u)}).then(function(e){return console.log("imported"),console.log(e),e},function(e){return console.log(e),t.reject(e)})},n}])}).call(this),function(){var e;(e=angular.module("archivist.users",["archivist.flash"])).controller("UserController",["$scope","$location","$http","$route","User","DataManager",function(e,t,n,r,i,s){return e.sign_in=function(n){return e.user.set("email",n.email),e.user.sign_in(n.password).then(function(){return t.path("/instruments")},function(){return e.publish_flash(),n.password="",s.clearCache(),r.reload(),console.log("User logged in.")})},e.sign_up=function(n){return e.user.set("email",n.email),e.user.set("first_name",n.fname),e.user.set("last_name",n.lname),e.user.set("group_id",n.group),e.user.sign_up(n.password,n.confirm).then(function(){return t.path("/instruments"),!0},function(){return e.publish_flash(),n.password="",n.confirm="",s.clearCache(),r.reload(),!1})},n.get("/user_groups/external.json").then(function(t){return e.sign_up_groups=t.data}),console.log(e)}]),e.factory("User",["$http","$q","$route","Flash","DataManager",function(e,t,n,r,i){return function(){function s(e){this.email=e,this.logged_in=!1}return s.attributes=["email","first_name","last_name","group","group_id","role"],s.prototype.sign_in=function(s){var o;return o=this,e.post("/users/sign_in.json",{user:{email:this.email,password:s,remember_me:1}}).then(function(e){return i.clearCache(),n.reload(),o.logged_in=!0,o.set("first_name",e.data.first_name),o.set("last_name",e.data.last_name),o.set("group",e.data.group),o.set("role",e.data.role),!0},function(e){return o.logged_in=!1,r.add("danger",e.data.error),t.reject(e.data.error)})},s.prototype.sign_out=function(){var t;return t=this,e["delete"]("/users/sign_out.json").then(function(){return i.clearCache(),n.reload()})["finally"](function(){return t.logged_in=!1})},s.prototype.sign_up=function(t,s){var o;return o=this,e.post("/users.json",{user:this.get_all_data({password:t,password_confirmation:s})}).then(function(e){return i.clearCache(),n.reload(),o.logged_in=!0,o.set("role",e.data.role)},function(e){return o.logged_in=!1,r.add("danger",e.errors)})},s.prototype.is_admin=function(){return"admin"===this.get("role")},s.prototype.is_editor=function(){return"admin"===this.get("role")||"editor"===this.get("role")},s.prototype.get=function(e){return this[e]},s.prototype.set=function(e,t){return this[e]=t},s.prototype.get_all_data=function(e){var t,n,r,i,s,o;for(null==e&&(e={}),s={},n=0,i=(o=this.constructor.attributes).length;n<i;n++)s[t=o[n]]=this.get(t);for(r in e)s[r]=e[r];return s},s}()}])}.call(this),function(){angular.module("archivist.datasets",["templates","ngRoute","archivist.datasets.index","archivist.datasets.show","archivist.datasets.edit"]).config(["$routeProvider",function(e){return e.when("/datasets",{templateUrl:"partials/datasets/index.html",controller:"DatasetsIndexController"}).when("/datasets/:id",{templateUrl:"partials/datasets/show.html",controller:"DatasetsShowController"}).when("/datasets/:id/edit",{templateUrl:"partials/datasets/edit.html",controller:"DatasetsEditController"})}])}.call(this),function(){angular.module("archivist.datasets.index",["archivist.data_manager"]).controller("DatasetsIndexController",["$scope","$http","DataManager",function(e,t,n){return e.datasets=n.getDatasets(),e.pageSize=24,e.currentPage=1,e.filterStudy=function(t){return e.filteredStudy=t},t.get("/studies.json").success(function(t){return e.studies=t}),console.log(e)}])}.call(this),function(){angular.module("archivist.datasets.show",["ngVis","archivist.data_manager"]).controller("DatasetsShowController",["$scope","$routeParams","VisDataSet","DataManager",function(e,t,n,r){return e.dataset=r.getDataset(t.id,{variables:!0,questions:!0},function(){return e.breadcrumbs=[{label:"Datasets",link:"/datasets",active:!1},{label:e.dataset.name,link:!1,active:!0}]}),e.pageSize=20,e.clusterMenuOptions=[["Remove Topic",function(e){return console.log("Removing topic"),console.log(e)}]],e.graphData={},e.graphOptions={interaction:{dragNodes:!1},layout:{hierarchical:{enabled:!0,direction:"LR"}}},e.graphEvents={click:function(t){if(1===t.nodes.length)return t.nodes[0]<2e7?("CcQuestion",t.nodes[0]-1e7):("Variable",t.nodes[0]-2e7),e.current_cluster_selection=e.graphData.nodes.get(t.nodes[0]),console.log(e)}},e.loadNetworkData=function(t){var i,s;return e.current_cluster_selection={topic:{name:""}},s=new n,i=new n,e.cluster=r.getCluster("Variable",t.id,!0,function(){var t,n,r,o,a,u,l,c,d,p,m,f,g;for({},t=0,o=(c=e.cluster.strands).length;t<o;t++)for(n=0,a=(d=(f=c[t]).members).length;n<a;n++)if((l=d[n]).id+="Variable"===l.type?2e7:1e7,l.group="strand:"+f.id.toString(),l.borderWidth=null!=l.topic?3:1,l.color={border:f.good?"black":"red"},g="<span",f.good||(g+=' style="color: red;"'),g+=">"+l.text,null!=l.topic&&(g+="<br/>"+l.topic.name),g+="</span>",l.title=g,s.add(l),null!=l.sources)for(r=0,u=(p=l.sources).length;r<u;r++)m=p[r],i.add({from:l.id,to:m.id+("Variable"===m.type?2e7:1e7),dashes:!m.interstrand});return console.log(s)}),e.graphData={nodes:s,edges:i}},e.split_mapping=function(e,t,n,r){return null==n&&(n=null),null==r&&(r=null),e.$split_mapping({other:{"class":t["class"],id:t.id},x:n,y:r})},e.detectKey=function(e,t,n,r){var i;return null==n&&(n=null),null==r&&(r=null),13===e.keyCode&&(i=e.target.value.split(","),t.$add_mapping({sources:{id:i,x:n,y:r}})),console.log(t)},console.log(e)}])}.call(this),function(){angular.module("archivist.datasets.edit",["archivist.data_manager"]).controller("DatasetsEditController",["$http","$scope","$routeParams","$location","Flash","DataManager",function(e,t,n,r,i,s){return t.dataset=s.getDataset(n.id,{},function(){return t.page.title=t.dataset.name+" | Edit",t.breadcrumbs=[{label:"Datasets",link:"/datasets",active:!1},{label:t.dataset.name,link:"/datasets/"+t.dataset.id,active:!1},{label:"Edit",link:!1,active:!0}]}),e.get("/studies.json").success(function(e){return t.studies=e}),t.updateDataset=function(){return t.dataset.$save({},function(){return i.add("success","Dataset updated successfully!"),r.path("/datasets"),s.clearCache()},function(){return i.add("error","Dataset could not be updated.")})}}])}.call(this),function(){}.call(this),function(){var e;(e=angular.module("archivist.instruments",["templates","ngRoute","ngResource","ui.bootstrap","archivist.flash","archivist.data_manager","naif.base64"])).config(["$routeProvider",function(e){return e.when("/instruments",{templateUrl:"partials/instruments/index.html",controller:"InstrumentsController"}).when("/instruments/:id",{templateUrl:"partials/instruments/show.html",controller:"InstrumentsController"}).when("/instruments/:id/edit",{templateUrl:"partials/instruments/edit.html",controller:"InstrumentsController"}).when("/instruments/:id/import",{templateUrl:"partials/instruments/import.html",controller:"InstrumentsController"})}]),e.controller("InstrumentsController",["$scope","$routeParams","$location","$q","$http","$timeout","Flash","DataManager","Base64Factory",function(e,t,n,r,i,s,o,a){var u,l;return e.page.title="Instruments",t.id?(!(u="edit"!==n.path().split("/")[n.path().split("/").length-1].toLowerCase()),e.loading={state:"Downloading",progress:0,type:"info"},l=function(t){if(e.loading.progress=t,e.loading.progress>99)return e.loading.state="Processing",e.loading.type="success"},e.instrument=a.getInstrument(t.id,{constructs:u,questions:u,progress:l},function(){return e.page.title=e.instrument.prefix+" | Edit",s(function(){return u&&(e.page.title=e.instrument.prefix+" | View",a.resolveConstructs(),a.resolveQuestions(),console.log(e)),e.breadcrumbs=[{label:"Instruments",link:"/instruments",active:!1},{label:e.instrument.prefix,link:!1,active:!1,subs:[{label:u?"Edit":"View",link:"/instruments/"+t.id+(u?"/edit":"")},{label:"Build",link:"/instruments/"+t.id+"/build"},{label:"Map",link:"/instruments/"+t.id+"/map"}]},{label:u?"View":"Edit",link:!1,active:!0}],e.loading.state="Done"},100)})):(e.instruments=a.getInstruments(),e.pageSize=24,e.currentPage=1,e.filterStudy=function(t){return e.filteredStudy=t},i.get("/studies.json").success(function(t){return e.studies=t})),e.updateInstrument=function(){return e.instrument.$save({},function(){return o.add("success","Instrument updated successfully!"),n.path("/instruments"),a.clearCache()},function(){return console.log("error")})}}]),e.factory("Base64Factory",["$q",function(e){return{getBase64:function(t){var n,r;return n=e.defer(),(r=new FileReader).readAsDataURL(t),r.onload=function(){n.resolve(r.result)},r.onerror=function(e){n.reject(e)},n.promise}}}])}.call(this),function(){angular.module("archivist.build",["templates","ngRoute","archivist.flash","archivist.data_manager","archivist.realtime"]).config(["$routeProvider","treeConfig",function(e,t){return e.when("/instruments/:id/build",{templateUrl:"partials/build/index.html",controller:"BuildMenuController"}).when("/instruments/:id/build/code_lists/:code_list_id?",{templateUrl:"partials/build/editor.html",controller:"BuildCodeListsController"}).when("/instruments/:id/build/response_domains/:response_domain_type?/:response_domain_id?",{templateUrl:"partials/build/editor.html",controller:"BuildResponseDomainsController"}).when("/instruments/:id/build/questions/:question_type?/:question_id?",{templateUrl:"partials/build/editor.html",controller:"BuildQuestionsController"}).when("/instruments/:id/build/constructs",{templateUrl:"partials/build/editor.html",controller:"BuildConstructsController",reloadOnSearch:!1}),t.placeholderClass="a-tree-placeholder a-construct list-group-item",t.hiddenClass="a-tree-hidden",t.dragClass="a-tree-drag"}])}.call(this),function(){angular.module("archivist.build").controller("BaseBuildController",["$scope","$routeParams","$location","$timeout","Flash","DataManager","RealTimeListener","RealTimeLocking",function(e,t,n,r,i,s,o,a){return e.page.title=e.title,e.underscored=e.title.toLowerCase().replaceAll(" ","_"),e.main_panel="partials/build/"+e.underscored+".html",e.url_path_args=n.path().split("/"),e.newMode="new"===e.url_path_args.slice(0).pop(),"function"==typeof e.before_instrument_loaded&&e.before_instrument_loaded(),e.instrument=s.getInstrument(t.id,e.instrument_options,function(){return e.page.title=e.instrument.prefix+" | "+e.title,e.reset(),e.breadcrumbs=[{label:"Instruments",link:"/instruments",active:!1},{label:e.instrument.prefix,link:"/instruments/"+e.instrument.id.toString(),active:!1},{label:"Build",link:"/instruments/"+e.instrument.id.toString()+"/build",active:!1},{label:e.title,link:!1,active:!0}],r(function(){return jQuery(".first-field").first().focus()},0),"function"==typeof e.after_instrument_loaded&&e.after_instrument_loaded(),console.log(e)}),null==e.cancel&&(e.cancel=function(){return console.log("cancel called"),e.newMode?e.editMode=e.newMode=!1:e.reset(),null}),null==e.edit_path&&(e.edit_path=function(t){var n;return n=["instruments",e.instrument.id,"build"],e.extra_url_parameters&&(n=n.concat(e.extra_url_parameters)),null!=t&&(null!=t.type&&n.push(t.type.replace(/([A-Z])/g,function(e,t){return"_"+t.toLowerCase()}).replace(/^_/,"")+"s"),n.push(t.id)),n.join("/")}),null==e.startEditMode&&(e.startEditMode=function(){return e.editMode=!0,console.log(e.current),a.lock({type:e.current.type,id:e.current.id}),null}),null==e.change_panel&&(e.change_panel=function(t){return localStorage.setItem("sidebar_scroll",jQuery(".sidebar").scrollTop()),n.url(e.edit_path(t))}),e.listener=o(function(){if(!e.editMode)return e.reset()})}])}.call(this),function(){var e=[].slice;angular.module("archivist.build").controller("BuildCodeListsController",["$controller","$scope","$routeParams","$location","$filter","$timeout","Flash","DataManager","RealTimeListener","RealTimeLocking",function(t,n,r,i,s,o,a,u,l,c){return console.log("called code_list controller"),n.load_sidebar=function(){var e,t;return e=function(e){return e.count=e.used_by.length,e},n.sidebar_objs=function(){var r,i,s,o;for(o=[],r=0,i=(s=n.instrument.CodeLists).length;r<i;r++)t=s[r],o.push(e(t));return o}().sort_by_property(),o(function(){var e;if(null!==(e=localStorage.getItem("sidebar_scroll")))return console.log(e),jQuery(".sidebar").scrollTop(e),localStorage.removeItem("sidebar_scroll")},0)},n["delete"]=function(){var e;if(null!=(e=n.instrument.CodeLists.get_index_by_id(parseInt(r.code_list_id))))return n.instrument.CodeLists[e].$delete({},function(){return n.instrument.CodeLists.splice(e,1),n.load_sidebar(),o(function(){return n.instrument.CodeLists.length>0?n.change_panel(n.instrument.CodeLists[0]):n.change_panel({type:"CodeList",id:"new"})},0)})},n.save=function(){var e;return console.log(n.current),"new"===r.code_list_id?(n.instrument.CodeLists.push(n.current),e=n.instrument.CodeLists.length-1,n.instrument.CodeLists[e].instrument_id=r.id):(angular.copy(n.current,n.instrument.CodeLists.select_resource_by_id(parseInt(r.code_list_id))),e=n.instrument.CodeLists.get_index_by_id(parseInt(r.code_list_id))),n.instrument.CodeLists[e].save({},function(e){return e.instrument_id=n.instrument.id,a.add("success","Code list updated successfully!"),n.reset(),n.load_sidebar(),u.Data.Codes.Categories=u.Codes.Categories.requery({instrument_id:n.instrument.id}),u.Data.ResponseDomains.Codes=u.ResponseDomains.Codes.requery({instrument_id:n.instrument.id}),u.Data.Codes.Categories.$promise.then(function(){return n.categories=u.Data.Codes.Categories}),u.Data.ResponseDomains.Codes.$promise.then(function(){return u.groupResponseDomains()})},function(){return console.log("error")}),u.Data.ResponseDomains[r.id]=null},n.title="Code Lists",n.instrument_options={codes:!0},n.reset=function(){if(console.log("reset called"),null==u.CodeResolver&&u.resolveCodes(),isNaN(r.code_list_id)||(n.current=angular.copy(n.instrument.CodeLists.select_resource_by_id(parseInt(r.code_list_id))),n.editMode=!1,null!=n.current&&c.unlock({type:n.current.type,id:n.current.id})),"new"===r.code_list_id)return n.editMode=!0,n.current=new u.Codes.CodeLists.resource({codes:[]})},n["new"]=function(){return n.change_panel({type:"CodeList",id:"new"})},n.removeCode=function(e){var t,r,i;for(r in n.current.codes=function(){var r,i,s,o;for(o=[],r=0,i=(s=n.current.codes).length;r<i;r++)(t=s[r]).$$hashKey!==e.$$hashKey&&o.push(t);return o}(),n.current.codes.sort(function(e,t){return e.order-t.order}),i=[],n.current.codes)i.push(n.current.codes[r].order=r);return i},n.moveUp=function(e){return n.moveCode(e,-1)},n.moveDown=function(e){return n.moveCode(e,1)},n.moveCode=function(t,r){var i,s,o,a,u;if((o=n.current.codes.findIndex(function(e){return e.$$hashKey===t.$$hashKey}))+r<0||o+r>=n.current.codes.length)return!1;for(s in i=n.current.codes.splice(o,1),(a=n.current.codes).splice.apply(a,[o+r,0].concat(e.call(i))),u=[],n.current.codes)u.push(n.current.codes[s].order=s);return u},n.after_instrument_loaded=function(){return n.categories=u.Data.Codes.Categories,console.log(n.sidebar_objs),n.load_sidebar(),n.$watch("current.newValue",function(e,t,r){if(console.log(e,t,r),e!==t&&null!=e)return r.current.codes.push({id:null,value:e,category:null,order:n.current.codes.length}),n.current.newValue=null,o(function(){var e;return jQuery(".code-value").last().focus(),e=2*jQuery(".code-value").last().val().length,jQuery(".code-value").last()[0].setSelectionRange(e,e)},0)})},t("BaseBuildController",{$scope:n,$routeParams:r,$location:i,Flash:a,DataManager:u,RealTimeListener:l,RealTimeLocking:c})}])}.call(this),function(){angular.module("archivist.build").controller("BuildConstructsController",["$controller","$scope","$routeParams","$location","$filter","$http","$timeout","bsLoadingOverlayService","Flash","DataManager","RealTimeListener","RealTimeLocking",function(e,t,n,r,i,s,o,a,u,l,c,d){return console.time("end to end"),t.title="Constructs",t.details_bar=!0,t.hide_edit_buttons=!0,t.extra_url_parameters=["constructs"],t.instrument_options={constructs:!0,questions:!0,rus:!0},t.index={},t.details_path=function(){return"partials/build/details/"+n.construct_type+".html"},t.setIndex=function(e,n,r){return null==r&&(r=null),null!=e?(t.index.parent_id=e,t.index.parent_type=n):(t.index.parent_id=t.instrument.topsequence.id,t.index.parent_type="sequence"),t.index.branch=r},t.$on("$routeUpdate",function(){return t.reset()}),t.change_panel=function(e){return r.search({construct_type:e.type,construct_id:e.id}),t.editMode=null!=e.type&&null!=e.id},t.treeOptions={dropped:function(){var e;return a.start(),t.updates=[],(e=function(n){var r,i,s,o,a,u,l;for(l=[],a=o=0,u=(r=["children","fchildren"]).length;o<u;a=++o)s=r[a],null!=n[s]?l.push(function(){var r;for(i in r=[],n[s])n[s].hasOwnProperty(i)?((n[s][i].position!==parseInt(i)+1||n[s][i].parent!==n.id||n[s][i].branch!==a&&Number.isInteger(n[s][i].branch))&&(t.updates.push({id:n[s][i].id,type:n[s][i].type,position:parseInt(i)+1,parent:{id:n.id,type:n.type},branch:a}),n[s][i].position=t.updates[t.updates.length-1].position,n[s][i].parent=t.updates[t.updates.length-1].parent),r.push(e(n[s][i]))):r.push(void 0);return r}()):l.push(void 0);return l})(t.instrument.topsequence),s.post("/instruments/"+t.instrument.id.toString()+"/reorder_ccs.json",{updates:t.updates})["finally"](function(){return a.stop()})}},t.toggle=function(e){return e.toggle()},t["delete"]=function(){var e,r;if(e=t.instrument.Constructs[n.construct_type.capitalizeFirstLetter()+"s"],null!=(r=e.get_index_by_id(parseInt(n.construct_id))))return e[r].$delete({},function(){var n,i;return n=e[r].$$hashKey,e.splice(r,1),(i=function(e,t){var n,s,o,a,u,l,c;if(void 0!==e.children){for(l=e.children,r=s=0,a=l.length;s<a;r=++s){if((n=l[r]).$$hashKey===t)return e.children.splice(r,1),!0;if(i(n,t))return!0}if(void 0!==e.fchildren)for(c=e.fchildren,r=o=0,u=c.length;o<u;r=++o){if((n=c[r]).$$hashKey===t)return e.fchildren.splice(r,1),!0;if(i(n,t))return!0}}return!1})(t.instrument.topsequence,n),o(function(){return t.change_panel({type:null,id:null})},0)})},t.save=function(){var e,r;return e=t.instrument.Constructs[n.construct_type.capitalizeFirstLetter()+"s"],"new"===n.construct_id?(e.push(t.current),r=e.length-1,e[r].instrument_id=n.id):(angular.copy(t.current,e.select_resource_by_id(parseInt(n.construct_id))),r=e.get_index_by_id(parseInt(n.construct_id))),e[r].save({},function(i){var s;return i.instrument_id=t.instrument.id,i.type=n.construct_type,u.add("success","Construct updated successfully!"),"new"===n.construct_id&&(s=l.Data.Instrument.Constructs[t.index.parent_type.capitalizeFirstLetter()+"s"].select_resource_by_id(t.index.parent_id),0===t.index.branch||null===t.index.branch?s.children.push(e[r]):s.fchildren.push(e[r]),t.change_panel(e[r])),t.change_panel({type:null,id:null}),t.reset()},function(){return u.add("danger","Construct failed to update"),console.error("Construct failed to update")})},t.reset=function(){var e,r,i,s;if(null!=n.construct_type&&!isNaN(parseInt(n.construct_id)))for(r=0,i=(s=t.instrument.Constructs[n.construct_type.capitalizeFirstLetter()+"s"]).length;r<i;r++)if((e=s[r]).type.pascal_case_to_underscore()===n.construct_type&&e.id.toString()===n.construct_id.toString()){t.current=angular.copy(e);break}return null},t.build_ru_options=function(){var e,n,r,i,s;for(t.details.ru_options=[],i=[],e=0,n=(r=t.instrument.ResponseUnits).length;e<n;e++)s=r[e],i.push(t.details.ru_options.push({value:s.id,label:s.label}));return i},t.after_instrument_loaded=function(){var e,n;return console.time("after instrument"),e=function(e,t){return e.position>t.position},t.instrument.topsequence.resolved||(l.resolveConstructs(),l.resolveQuestions(),(n=function(t){var r,i,s,o,a,u,l,c;if(null!=t.children){for(t.children.sort(e),i=0,o=(u=t.children).length;i<o;i++)r=u[i],n(r);if(null!=t.fchildren){for(t.fchildren.sort(e),c=[],s=0,a=(l=t.fchildren).length;s<a;s++)r=l[s],c.push(n(r));return c}}})(t.instrument.topsequence)),t.details={},t.details.options=l.getQuestionIDs(),t.build_ru_options(),console.timeEnd("after instrument"),console.timeEnd("end to end")},t.save_ru=function(e){return l.Data.ResponseUnits.push(new l.ResponseUnits.resource({label:e.label,instrument_id:n.id})),l.Data.ResponseUnits[l.Data.ResponseUnits.length-1].save({},function(e){return e.instrument_id=t.instrument.id,t.build_ru_options()})},t["new"]=function(e){var n;return n="question"===e?l.Constructs.Questions.cc.resource:l.Constructs[e.capitalizeFirstLetter()+"s"].resource,t.current=new n({type:e,parent:{id:t.index.parent_id,type:t.index.parent_type},branch:t.index.branch}),r.search({construct_type:e,construct_id:"new"}),t.reset(),t.editMode=!0},console.time("load base"),e("BaseBuildController",{$scope:t,$routeParams:n,$location:r,Flash:u,DataManager:l,RealTimeListener:c,RealTimeLocking:d}),console.timeEnd("load base")}]),angular.module("archivist.build").controller("BuildConstructsFirstBranchController",["$scope",function(e){return e.branch="condition"===e.obj.type?0:null}]),angular.module("archivist.build").controller("BuildConstructsSecondBranchController",["$scope",function(e){return e.branch=1}])}.call(this),function(){angular.module("archivist.build").controller("BuildMenuController",["$scope","$routeParams","DataManager",function(e,t,n){return e.code_lists_url="/instruments/"+t.id+"/build/code_lists",e.response_domains_url="/instruments/"+t.id+"/build/response_domains",e.questions_url="/instruments/"+t.id+"/build/questions",e.constructs_url="/instruments/"+t.id+"/build/constructs",e.summary_url=function(e){return"/instruments/"+t.id+"/summary/"+e},e.instrument=n.getInstrumentStats(t.id,function(){return e.stats=e.instrument.stats,e.breadcrumbs=[{label:"Instruments",link:"/instruments",active:!1},{label:e.instrument.prefix,link:"/instruments/"+t.id,active:!1},{label:"Build",link:!1,active:!0}]})}])}.call(this),function(){angular.module("archivist.build").controller("BuildQuestionsController",["$controller","$scope","$routeParams","$location","$timeout","Flash","DataManager","RealTimeListener","RealTimeLocking",function(e,t,n,r,i,s,o,a,u){return t.load_sidebar=function(){return t.sidebar_objs=t.instrument.Questions.Items.concat(t.instrument.Questions.Grids).sort_by_property()},t.add_rd=function(e){return"question_items"===n.question_type?(null==t.current.rds&&(t.current.rds=[]),t.current.rds.push(e)):(t.current_grid_column.rd=e,jQuery("#add-rd").modal("hide"),!0)},t.remove_rd=function(e){var r;return"question_items"===n.question_type?(r=t.current.rds.indexOf(e),t.current.rds.splice(r,1)):e.rd=null},t["delete"]=function(){var e,r;if(null!=(r="question_items"===n.question_type?"Items":"Grids")&&null!=(e=t.instrument.Questions[r].get_index_by_id(parseInt(n.question_id))))return t.instrument.Questions[r][e].$delete({},function(){return t.instrument.Questions[r].splice(e,1),t.load_sidebar(),i(function(){return t.instrument.Questions[r].length>0?t.change_panel(t.instrument.Questions[r][0]):t.change_panel({type:n.question_type,id:"new"})},0)})},t.select_x_axis=function(){return t.current.cols=angular.copy(t.instrument.CodeLists.select_resource_by_id(t.current.horizontal_code_list_id).codes)},t.set_grid_column=function(e){return t.current_grid_column=e},t.save=function(){var e,r;if(null!=(r="question_items"===n.question_type?"Items":"Grids"))return"new"===n.question_id?(t.instrument.Questions[r].push(t.current),e=t.instrument.Questions[r].length-1,t.instrument.Questions[r][e].instrument_id=n.id):(angular.copy(t.current,t.instrument.Questions[r].select_resource_by_id(parseInt(n.question_id))),e=t.instrument.Questions[r].get_index_by_id(parseInt(n.question_id))),t.instrument.Questions[r][e].save({},function(e){return e.instrument_id=t.instrument.id,s.add("success","Question updated successfully!"),t.reset(),t.load_sidebar()},function(){return console.log("error")})},t.title="Questions",t.extra_url_parameters=["questions"],t.instrument_options={questions:!0,rds:!0,codes:!0},t.reset=function(){return console.log("reset called"),null!=n.question_type&&("question_items"===n.question_type?(t.current=angular.copy(t.instrument.Questions.Items.select_resource_by_id(parseInt(n.question_id))),t.title="Question Item"):(t.current=angular.copy(t.instrument.Questions.Grids.select_resource_by_id(parseInt(n.question_id))),t.title="Question Grid"),t.editMode=!1,null!=t.current&&u.unlock({type:t.current.type,id:t.current.id}),"new"===n.question_id&&(t.editMode=!0,"question_items"===n.question_type?(t.current=new o.Constructs.Questions.item.resource({}),t.current.type="QuestionItem"):"question_grids"===n.question_type&&(t.current=new o.Constructs.Questions.grid.resource({}),t.current.type="QuestionGrid"))),null},t["new"]=function(e){return null==e&&(e=!1),!1===e?jQuery("#new-question").modal("show"):i(function(){return t.change_panel({type:e,id:"new"})},0),null},t.after_instrument_loaded=function(){return t.load_sidebar(),o.resolveCodes(),console.log(t.sidebar_objs)},e("BaseBuildController",{$scope:t,$routeParams:n,$location:r,$timeout:i,Flash:s,DataManager:o,RealTimeListener:a,RealTimeLocking:u})}])}.call(this),function(){
angular.module("archivist.build").controller("BuildResponseDomainsController",["$controller","$scope","$routeParams","$location","$filter","$timeout","Flash","DataManager","Map","RealTimeListener","RealTimeLocking",function(e,t,n,r,i,s,o,a,u,l,c){return t.load_sidebar=function(){return t.sidebar_objs=i("excludeRDC")(t.instrument.ResponseDomains).sort_by_property()},t.title="Response Domains",t.extra_url_parameters=["response_domains"],t.instrument_options={rds:!0},t["delete"]=function(){var e,r;switch(n.response_domain_type){case"response_domain_texts":r="ResponseDomainText";break;case"response_domain_datetimes":r="ResponseDomainDatetime";break;case"response_domain_numerics":r="ResponseDomainNumeric";break;default:r=!1}if(null!=r&&null!=(e=t.instrument.ResponseDomains.get_index_by_id_and_type(parseInt(n.response_domain_id),r)))return t.instrument.ResponseDomains[e].$delete({},function(){return t.instrument.ResponseDomains.splice(e,1),t.load_sidebar(),s(function(){return t.instrument.ResponseDomains.length>0?t.change_panel(t.instrument.ResponseDomains[0]):t.change_panel({type:r,id:"new"})},0)})},t.save=function(){var e,r,i,s,l;switch(n.response_domain_type){case"response_domain_texts":s="ResponseDomainText";break;case"response_domain_datetimes":s="ResponseDomainDatetime";break;case"response_domain_numerics":s="ResponseDomainNumeric";break;case"new":s="new";break;default:s=!1}if(s){if("new"===s){for(i in l=u.find(a,t.current.type),e=u.find(a.Data,t.current.type),console.log(e),e.push(new l.resource),r=e.length-1,t.current)e[r][i]=t.current[i];e[r].instrument_id=n.id}else r=(e=t.instrument.ResponseDomains).get_index_by_id_and_type(parseInt(n.response_domain_id),s),angular.copy(t.current,e[r]);return e[r].save({},function(e){return e.instrument_id=t.instrument.id,o.add("success","Response Domain updated successfully!"),a.groupResponseDomains(),t.reset(),t.load_sidebar()},function(){return console.log("error")})}},t.reset=function(){var e,r,i,s;if(null!=n.response_domain_type&&null!=n.response_domain_id)for(e=0,r=(s=t.instrument.ResponseDomains).length;e<r;e++)if((i=s[e]).type.pascal_case_to_underscore()+"s"===n.response_domain_type&&i.id.toString()===n.response_domain_id){t.current=angular.copy(i),t.editMode=!1,null!=t.current&&c.unlock({type:t.current.type,id:t.current.id});break}return"new"===n.response_domain_type&&(t.editMode=!0,t.current={}),null},t["new"]=function(){return s(function(){return t.change_panel({type:null,id:"new"})},0),null},t.after_instrument_loaded=function(){return t.load_sidebar()},e("BaseBuildController",{$scope:t,$routeParams:n,$location:r,$timeout:s,Flash:o,DataManager:a,RealTimeListener:l,RealTimeLocking:c})}])}.call(this),function(){angular.module("archivist.build").directive("resumeScroll",["$timeout",function(e){return{scope:{key:"@"},link:{postLink:function(t,n){return e(function(){return console.log(t),n.scrollTop=localStorage.getItem("sidebar-scroll-top"),localStorage.removeItem("sidebar-scroll-top")}),t.$on("$destroy",function(){return localStorage.setItem("sidebar-scroll-top",n.scrollTop)})}}}}])}.call(this),function(){angular.module("archivist.build").directive("strip",[function(){return{scope:{key:"@"},link:{postLink:function(e,t){return t.text=t.text.replaceAll("ResponseDomain","")}}}}])}.call(this),function(){angular.module("archivist.build").filter("excludeRDC",function(){return function(e){var t;return t=[],angular.forEach(e,function(e){if("ResponseDomainCode"!==e.type)return t.push(e)}),t}})}.call(this),function(){angular.module("archivist.build").filter("stripRD",function(){return function(e){return e.replace("ResponseDomain","")}})}.call(this),function(){angular.module("archivist.summary",["templates","ngRoute"]).config(["$routeProvider",function(e){return e.when("/instruments/:id/summary",{templateUrl:"partials/summary/index.html",controller:"SummaryIndexController"}).when("/instruments/:id/summary/:object_type",{templateUrl:"partials/summary/show.html",controller:"SummaryShowController"})}])}.call(this),function(){angular.module("archivist.summary").controller("SummaryShowController",["$scope","$routeParams","$filter","DataManager","Map","RealTimeListener",function(e,t,n,r,i){var s,o,a;for(s in e.object_type=t.object_type.underscore_to_pascal_case(),o=Object.lower_everything(i.map[e.object_type]))a=o[s],o[s]={},o[s][a]=!0;return o.topsequence=!1,e.instrument=r.getInstrument(t.id,o,function(){var t,n,s,o,a,u,l,c,d;for(t=["id","label","literal","base_label","response_unit_label","logic"],n=i.find(r.Data,e.object_type),e.data=[],o=a=0,l=n.length;a<l;o=++a){for(s in c={},d=n[o])-1!==t.indexOf(s)&&(c[s]=d[s]);e.data.push(c)}return e.cols=function(){var t;for(u in t=[],e.data[0])t.push(u);return t}(),e.breadcrumbs=[{label:"Instruments",link:"/instruments",active:!1},{label:e.instrument.prefix,link:"/instruments/"+e.instrument.prefix,active:!1},{label:"Summary",link:!1,active:!1},{label:e.object_type,link:!1,active:!0}],console.log(e)})}])}.call(this),function(){}.call(this),function(){var e;(e=angular.module("archivist.mapping",["ngRoute","archivist.flash","archivist.data_manager"])).config(["$routeProvider",function(e){return e.when("/instruments/:id/map",{templateUrl:"partials/instruments/map.html",controller:"MappingController"})}]),e.controller("MappingController",["$scope","$routeParams","DataManager",function(e,t,n){var r;return e.instrument=n.getInstrument(t.id,{constructs:!0,questions:!0,variables:!0},function(){return n.resolveConstructs(),n.resolveQuestions()}),e.tags={},e.variable={},e.addVariable=function(t,n){return e.tags[n]=e.tags[n]||[],e.tags[n]=r(e.tags[n],t,n)},e.deleteVariable=function(t,n){return e.tags[t].splice(n,1)},e.detectKey=function(e,t,r,i){var s;return null==r&&(r=null),null==i&&(i=null),13===e.keyCode&&(s=e.target.value.split(","),t.$add_mapping({variable_names:s,x:null,y:null},function(){return n.resolveQuestions()})),console.log(t)},r=function(t,n,r){return console.log(t),-1===t.map(function(e){return e.id}).indexOf(n.id)&&t.push(n),e.variable.added[r]=null,t},console.log("Controller scope"),console.log(e),e.split_mapping=function(e,t,n,r){return null==n&&(n=null),null==r&&(r=null),e.$split_mapping({variable_id:t,x:n,y:r})}}]),e.directive("aTopics",["$compile","bsLoadingOverlayService","DataManager","Flash",function(e,t,n,r){var i;return i=function(e){return console.log(e),'<select class="form-control" data-ng-model="model.topic.id" data-ng-init="model.topic.id = model.topic.id || model.ancestral_topic.id" style="width: 100%; max-width:600px;" convert-to-number data-ng-change="updateTopic()" data-ng-if="model.topic || !model.strand"><option value=""><em>Clear</em></option><option data-ng-repeat="topic in topics" data-ng-selected="topic.id == model.topic.id" data-a-topic-indent="{{topic.level}}" class="a-topic-level-{{topic.level}}" value="{{topic.id}}">{{topic.name}}</option></select><span class="a-topic" data-ng-if="!model.topic && model.strand">{{model.strand.topic.name}}</span>'},{restrict:"E",require:"ngModel",scope:{model:"=ngModel"},link:{post:function(s,o){var a;return a=function(){var t;return console.log("a topic init"),s.model.orig_topic=s.model.topic,s.topics=n.getTopics({flattened:!0}),t=e(i(s))(s),o.replaceWith(t)},s.updateTopic=function(){return t.start(),n.updateTopic(s.model,s.model.topic.id).then(function(){return s.model.orig_topic=s.model.topic},function(e){return s.model.topic=s.model.orig_topic,r.add("danger",e.data.message)})["finally"](function(){return t.stop()})},a()}}}}]),e.directive("aTopicIndent",[function(){return{restrict:"A",scope:{},link:{post:function(e,t,n){return e.$watch("topic",function(){return t.text("--".repeat(parseInt(n.aTopicIndent)-1)+t.text())})}}}}])}.call(this),function(){var e;(e=angular.module("archivist.topics",["ngRoute","archivist.data_manager"])).config(["$routeProvider",function(e){return e.when("/topics",{templateUrl:"partials/topics/index.html",controller:"TopicsIndexController"})}]),e.controller("TopicsIndexController",["$scope","$routeParams","DataManager","Topics",function(e,t,n,r){return e.data=n.getTopics({nested:!0}),e.treeOptions={dirSelectable:!1},e.showSelected=function(t,n){return n?(e.node=t,e.quesiton_stats=e.variable_stats=null,console.log(t),console.log(r),e.question_stats=r.questionStatistics({id:t.id}),e.variable_stats=r.variableStatistics({id:t.id})):(e.node=null,e.quesiton_stats=e.variable_stats=e.node=null)},console.log(e)}])}.call(this),function(){}.call(this);