(function(){angular.module("archivist.data_manager",["archivist.data_manager.map","archivist.data_manager.instruments","archivist.data_manager.constructs","archivist.data_manager.codes","archivist.data_manager.response_units","archivist.data_manager.response_domains","archivist.data_manager.datasets","archivist.data_manager.variables","archivist.data_manager.variables_instrument","archivist.data_manager.resolution","archivist.data_manager.stats","archivist.data_manager.topics","archivist.data_manager.auth","archivist.realtime","archivist.resource"]).factory("DataManager",["$http","$q","Map","Instruments","Constructs","Codes","ResponseUnits","ResponseDomains","ResolutionService","RealTimeListener","GetResource","ApplicationStats","Topics","InstrumentStats","Datasets","Variables","VariablesInstrument","Auth",function(t,s,e,n,a,r,o,u,i,c,l,p,D,m,d,C,h,f){var v;return(v={}).Data={},v.Instruments=n,v.Constructs=a,v.Codes=r,v.ResponseUnits=o,v.ResponseDomains=u,v.Datasets=d,v.Variables=C,v.VariablesInstrument=h,v.Auth=f,v.clearCache=function(){return v.Data={},v.Data.ResponseDomains={},v.Data.ResponseUnits={},v.Data.InstrumentStats={},v.Data.Users={},v.Data.Groups={},v.Data.Clusters={},v.Instruments.clearCache(),v.Constructs.clearCache(),v.Codes.clearCache(),v.ResponseUnits.clearCache(),v.Datasets.clearCache(),v.Variables.clearCache(),v.VariablesInstrument.clearCache(),v.Auth.clearCache()},v.clearCache(),v.getInstruments=function(t,s,e){return v.Data.Instruments=v.Instruments.query(t,s,e),v.Data.Instruments},v.getDatasets=function(t,s,e){return v.Data.Datasets=v.Datasets.query(t,s,e),v.Data.Datasets},v.getInstrument=function(t,e,n){var a,r,o,u,i,c,l;for(null==e&&(e={}),console.log("getInstrument"),v.progress=0,null==e.codes&&(e.codes=!1),null==e.constructs&&(e.constructs=!1),null==e.questions&&(e.questions=!1),null==e.rds&&(e.rds=!1),null==e.rus&&(e.rus=!1),null==e.instrument&&(e.instrument=!0),null==e.topsequence&&(e.topsequence=!0),null==e.variables&&(e.variables=!1),l=[],v.Data.Instrument=v.Instruments.get({id:t}),l.push(v.Data.Instrument.$promise),e.codes&&(null==(a=v.Data).Codes&&(a.Codes={}),v.Data.Codes.CodeLists=v.Codes.CodeLists.query({instrument_id:t}),l.push(v.Data.Codes.CodeLists.$promise),v.Data.Codes.Categories=v.Codes.Categories.query({instrument_id:t}),l.push(v.Data.Codes.Categories.$promise)),e.constructs&&(null==(r=v.Data).Constructs&&(r.Constructs={}),(!0===e.constructs||e.constructs.conditions)&&(v.Data.Constructs.Conditions=v.Constructs.Conditions.query({instrument_id:t}),l.push(v.Data.Constructs.Conditions.$promise.then(function(t){var s,e,n,a;for(a=[],e=s=0,n=t.length;s<n;e=++s)t[e],a.push(t[e].type="condition");return a}))),(!0===e.constructs||e.constructs.loops)&&(v.Data.Constructs.Loops=v.Constructs.Loops.query({instrument_id:t}),l.push(v.Data.Constructs.Loops.$promise.then(function(t){var s,e,n,a;for(a=[],e=s=0,n=t.length;s<n;e=++s)t[e],a.push(t[e].type="loop");return a}))),(!0===e.constructs||e.constructs.questions)&&(v.Data.Constructs.Questions=v.Constructs.Questions.cc.query({instrument_id:t}),l.push(v.Data.Constructs.Questions.$promise.then(function(t){var s,e,n,a;for(a=[],e=s=0,n=t.length;s<n;e=++s)t[e],a.push(t[e].type="question");return a}))),(!0===e.constructs||e.constructs.statements)&&(v.Data.Constructs.Statements=v.Constructs.Statements.query({instrument_id:t}),l.push(v.Data.Constructs.Statements.$promise.then(function(t){var s,e,n,a;for(a=[],e=s=0,n=t.length;s<n;e=++s)t[e],a.push(t[e].type="statement");return a}))),(!0===e.constructs||e.constructs.sequences)&&(v.Data.Constructs.Sequences=v.Constructs.Sequences.query({instrument_id:t}),l.push(v.Data.Constructs.Sequences.$promise.then(function(t){var s,e,n,a;for(console.log("sequence altering"),a=[],e=s=0,n=t.length;s<n;e=++s)t[e],a.push(t[e].type="sequence");return a})),e.instrument&&("undefined"==typeof v.Data.Instrument.Constructs&&(v.Data.Instrument.Constructs={}),v.Data.Instrument.Constructs.Sequences=v.Data.Constructs.Sequences))),e.questions&&(null==(o=v.Data).Questions&&(o.Questions={}),v.Data.Questions.Items=v.Constructs.Questions.item.query({instrument_id:t}),l.push(v.Data.Questions.Items.$promise),v.Data.Questions.Grids=v.Constructs.Questions.grid.query({instrument_id:t}),l.push(v.Data.Questions.Grids.$promise)),e.rds&&(v.Data.ResponseDomains={},v.Data.ResponseDomains.Codes=v.ResponseDomains.Codes.query({instrument_id:t}),l.push(v.Data.ResponseDomains.Codes.$promise),v.Data.ResponseDomains.Datetimes=v.ResponseDomains.Datetimes.query({instrument_id:t}),l.push(v.Data.ResponseDomains.Datetimes.$promise),v.Data.ResponseDomains.Numerics=v.ResponseDomains.Numerics.query({instrument_id:t}),l.push(v.Data.ResponseDomains.Numerics.$promise),v.Data.ResponseDomains.Texts=v.ResponseDomains.Texts.query({instrument_id:t}),l.push(v.Data.ResponseDomains.Texts.$promise)),e.rus&&(v.Data.ResponseUnits=v.ResponseUnits.query({instrument_id:t}),l.push(v.Data.ResponseUnits.$promise)),e.variables&&(v.Data.Variables=v.VariablesInstrument.query({instrument_id:t}),l.push(v.Data.Variables.$promise)),u=100/l.length,i=0,c=l.length;i<c;i++)l[i]["finally"](function(){if(v.progress+=u,null!=e.progress)return e.progress(v.progress)});return s.all(l).then(function(){var t,s;return console.log("All promises resolved"),e.instrument&&(e.constructs&&(v.Data.Instrument.Constructs={},v.Data.Instrument.Constructs.Conditions=v.Data.Constructs.Conditions,v.Data.Instrument.Constructs.Loops=v.Data.Constructs.Loops,v.Data.Instrument.Constructs.Questions=v.Data.Constructs.Questions,v.Data.Instrument.Constructs.Sequences=v.Data.Constructs.Sequences,v.Data.Instrument.Constructs.Statements=v.Data.Constructs.Statements),e.questions&&(null==(t=v.Data.Instrument).Questions&&(t.Questions={}),v.Data.Instrument.Questions.Items=v.Data.Questions.Items,v.Data.Instrument.Questions.Grids=v.Data.Questions.Grids),e.codes&&(v.Data.Instrument.CodeLists=v.Data.Codes.CodeLists),e.rds&&v.groupResponseDomains(),e.rus&&(v.Data.Instrument.ResponseUnits=v.Data.ResponseUnits),e.variables&&(v.Data.Instrument.Variables=v.Data.Variables)),console.log("callbacks called"),e.constructs&&e.instrument&&e.topsequence&&(v.Data.Instrument.topsequence=function(){var t,e,n,a;for(a=[],t=0,e=(n=v.Data.Instrument.Constructs.Sequences).length;t<e;t++)(s=n[t]).top&&a.push(s);return a}()[0]),"function"==typeof n?n():void 0}),v.Data.Instrument},v.getDataset=function(t,e,n){var a;return null==e&&(e={}),null==e.variables&&(e.variables=!1),null==e.questions&&(e.questions=!1),a=[],v.Data.Dataset=v.Datasets.get({id:t,questions:e.questions}),a.push(v.Data.Dataset.$promise),e.variables&&(v.Data.Variables=v.Variables.query({dataset_id:t}),a.push(v.Data.Variables.$promise)),s.all(a).then(function(){return e.variables&&(v.Data.Dataset.Variables=v.Data.Variables),"function"==typeof n?n():void 0}),v.Data.Dataset},v.groupResponseDomains=function(){return v.Data.Instrument.ResponseDomains=v.Data.ResponseDomains.Datetimes.concat(v.Data.ResponseDomains.Numerics,v.Data.ResponseDomains.Texts,v.Data.ResponseDomains.Codes)},v.getResponseUnits=function(t,s,e){return null==s&&(s=!1),null==v.Data.ResponseUnits[t]||s?v.Data.ResponseUnits[t]=l("/instruments/"+t+"/response_units.json",!0,e):"function"==typeof e?e():void 0},v.getCluster=function(t,s,e,n){var a;return null==e&&(e=!1),a=t+"/"+s,null==v.Data.Clusters[a]||e?v.Data.Clusters[a]=l("/clusters/"+a+".json",!0,n):"function"==typeof n&&n(),v.Data.Clusters[a]},v.resolveConstructs=function(){return null==v.ConstructResolver&&(v.ConstructResolver=new i.ConstructResolver(v.Data.Constructs)),v.ConstructResolver.broken_resolve()},v.resolveQuestions=function(){return null==v.QuestionResolver&&(v.QuestionResolver=new i.QuestionResolver(v.Data.Questions)),v.QuestionResolver.resolve(v.Data.Constructs.Questions)},v.resolveCodes=function(){return null==v.CodeResolver&&(v.CodeResolver=new i.CodeResolver(v.Data.Codes.CodeLists,v.Data.Codes.Categories)),v.CodeResolver.resolve()},v.getApplicationStats=function(){return v.Data.AppStats={$resolved:!1},v.Data.AppStats.$promise=p,v.Data.AppStats.$promise.then(function(t){var s;for(s in t.data)t.data.hasOwnProperty(s)&&(v.Data.AppStats[s]=t.data[s]);return v.Data.AppStats.$resolved=!0}),v.Data.AppStats},v.getTopics=function(t){return null==t&&(t={}),null==t.nested&&(t.nested=!1),null==t.flattened&&(t.flattened=!1),t.nested&&(v.Data.Topics=D.getNested()),t.flattened&&(v.Data.Topics=D.getFlattenedNest()),v.Data.Topics},v.updateTopic=function(t,s){return console.log(t),delete t.topic,delete t.strand,delete t.suggested_topic,t.$update_topic({topic_id:Number.isInteger(s)?s:null})},v.getInstrumentStats=function(t,s){return v.Data.InstrumentStats[t]={$resolved:!1},v.Data.InstrumentStats[t].$promise=m(t),v.Data.InstrumentStats[t].$promise.then(function(e){var n;for(n in e.data)e.data.hasOwnProperty(n)&&(v.Data.InstrumentStats[t][n]=e.data[n]);if(v.Data.InstrumentStats[t].$resolved=!0,null!=s)return s.call()}),v.Data.InstrumentStats[t]},v.getQuestionItemIDs=function(){var t,s,e,n,a;for(e=[],t=0,s=(a=v.Data.Questions.Items).length;t<s;t++)n=a[t],e.push({value:n.id,label:n.label,type:"QuestionItem"});return e},v.getQuestionGridIDs=function(){var t,s,e,n,a;for(e=[],t=0,s=(a=v.Data.Questions.Grids).length;t<s;t++)n=a[t],e.push({value:n.id,label:n.label,type:"QuestionGrid"});return e},v.getQuestionIDs=function(){return v.getQuestionItemIDs().concat(v.getQuestionGridIDs())},v.getUsers=function(){var t;return t=[],v.Data.Users=v.Auth.Users.query(),t.push(v.Data.Users.$promise),v.Data.Groups=v.Auth.Groups.query(),t.push(v.Data.Groups.$promise),s.all(t).then(function(){return null==v.GroupResolver&&(v.GroupResolver=new i.GroupResolver(v.Data.Groups,v.Data.Users)),v.GroupResolver.resolve()})},v.listener=c(function(t,s){var n,a,r,o,u,i,c,l,p,D,m,d,C;if(console.log("Rt update"),null!=s.data){for(m=!1,d=!1,a=0,o=(D=s.data).length;a<o;a++){C=D[a];try{if(null!=(u=e.find(v.Data,C.type).select_resource_by_id(C.id))){for(r in"question"===u.type&&(l=u.question_id,p=u.question_type),C)C[r],-1===["id","type"].indexOf(r)&&(-1!==["children","fchildren"].indexOf(r)&&(i=u.children,c=u.fchildren),u[r]=C[r],-1===["children","fchildren"].indexOf(r)||i===u.children&&c===u.fchildren||(m=!0));"question"!==u.type||l===u.question_id&&p===u.question_type||(u.base=null,d=!0)}else if("Instrument"!==C.type&&null!=C.action&&"ADD"===C.action&&null!=C.instrument_id&&C.instrument_id===v.Data.Instrument.id){for(r in n=e.find(v.Data,C.type),u=new(0,e.find(v,C.type).resource)({}),console.log(u),C)C[r],u[r]=C[r];-1!==["CcLoop","CcCondition","CcQuestion","CcStatement","CcSequence"].indexOf(u.type)&&(u.type=e.translate(u.type)),console.log(u),n.push(u)}}catch(h){}if("Instrument"===C.type&&C.id===v.Data.Instrument.id)for(r in C)C[r],-1===["id","type"].indexOf(r)&&(v.Data.Instrument[r]=C[r])}if(d&&v.resolveQuestions(),m)return v.resolveConstructs()}}),v}])}).call(this);