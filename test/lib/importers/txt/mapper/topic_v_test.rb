require 'test_helper'
require 'active_support/core_ext/hash/conversions'

class Importers::TXT::Mapper::TopicVTest < ActiveSupport::TestCase

  setup do
    @dataset = datasets 'Dataset_1'
  end

  describe "where dataset already has tv mappings" do
    describe "tv mappings from tab delimited text file" do
      it "should create a new mappings for the topic and variables" do
        var = @dataset.variables.find_by_name('aln')
        new_txt = "aln\t10320\nqlet\t10320\n"
        doc = Document.create(file: new_txt, item: @dataset)
        Importers::TXT::Mapper::TopicV.new(doc.id, {:object=>@dataset.id.to_s}).import
        assert_equal(@dataset.variables.find_by_name('aln').fully_resolved_topic_code, '10320')
        assert_equal(@dataset.variables.find_by_name('qlet').fully_resolved_topic_code, '10320')
      end
    end
    describe "tv mappings from tab delimited text file does not match any mappings" do
      it "should create a new mappings for the topic and variables" do
        var = @dataset.variables.find_by_name('kw0001')
        Link.create(target_type: 'Variable', target_id: var.id, topic_id: 2)
        assert_equal('102', var.reload.fully_resolved_topic_code)
        new_txt = "aln\t10320\n"
        doc = Document.create(file: new_txt, item: @dataset)
        Importers::TXT::Mapper::TopicV.new(doc.id, {:object=>@dataset.id.to_s}).import
        assert_equal('0', var.reload.fully_resolved_topic_code)
      end
    end
  end
end


[156712, 156711, 156710, 156709, 156708, 156707, 156706, 156705, 156704, 156703, 156702, 156701, 156700, 156699, 156698, 156697, 156696, 156695, 156694, 156693, 156692, 156691, 156690, 156689, 156688, 156687, 156686, 156685, 156684, 156683, 156682, 156681, 156680, 156679, 156678, 156677, 156676, 156675, 156674, 156673, 156672, 156671, 156670, 156669, 156668, 156667, 156666, 156665, 156664, 156663, 156662, 156661, 156660, 156659, 156658, 156657, 156656, 156655, 156654, 156653, 156652, 156651, 156650, 156649, 156648, 156647, 156646, 156645, 156644, 156643, 156642, 156641, 156640, 156639, 156638, 156637, 156636, 156635, 156634, 156633, 156632, 156631, 156630, 156629, 156628, 156627, 156626, 156625, 156624, 156623, 156622, 156621, 156620, 156619, 156618, 156617, 156616, 156615, 156614, 156613, 156612, 156611, 156610, 156609, 156608, 156607, 156606, 156605, 156604, 156603, 156602, 156601, 156600, 156599, 156598, 156597, 156596, 156595, 156594, 156593, 156592, 156591, 156590, 156589, 156588, 156587, 156586, 156585, 156584, 156583, 156582, 156581, 156580, 156579, 156578, 156577, 156576, 156575, 156574, 156573, 156572, 156571, 156570, 156569, 156568, 156567, 156566, 156565, 156564, 156563, 156562, 156561, 156560, 156559, 156558, 156557, 156556, 156555, 156554, 156553, 156552, 156551, 156550, 156549, 156548, 156547, 156546, 156545, 156544, 156543, 156542, 156541, 156540, 156539, 156538, 156537, 156536, 156535, 156534, 156533, 156532, 156531, 156530, 156529, 156528, 156527, 156526, 156525, 156524, 156523, 156522, 156521, 156520, 156519, 156518, 156517, 156516, 156515, 156514, 156513, 156512, 156511, 156510, 156509, 156508, 156507, 156506, 156505, 156504, 156503, 156502, 156501, 156500, 156499, 156498, 156497, 156478, 156477, 156476, 156475, 156474, 156473, 156472, 156471, 156470, 156469, 156468, 156467, 156466, 156465, 156464, 156463, 156462, 156461, 156460, 156459, 156458, 156457, 156456, 156455, 156454, 156453, 156452, 156451, 156450, 156449, 156448, 156447, 156446, 156445, 156444, 156443, 156442, 156441, 156440, 156439, 156438, 156437, 156436, 156435, 156434, 156433, 156432, 156431, 156430, 156429, 156428, 156427, 156426, 156425, 156424, 156423, 156422, 156421, 156420, 156419, 156418, 156417, 156416, 156415, 156414, 156413, 156412, 156411, 156410, 156409, 156408, 156407, 156406, 156405, 156404, 156403, 156402, 156401, 156400, 156399, 156398, 156397, 156396, 156395, 156394, 156393, 156392, 156391, 156390, 156389, 156388, 156387, 156386, 156385, 156384, 156383, 156382, 156381, 156380, 156379, 156378, 156377, 156376, 156375, 156374, 156373, 156372, 156371, 156370, 156369, 156368, 156367, 156366, 156365, 156364, 156363, 156362, 156361, 156360, 156359, 156358, 156357, 156356, 156355, 156354, 156353, 156352, 156351, 156350, 156349, 156348, 156347, 156346, 156345, 156344, 156343, 156342, 156341, 156340, 156339, 156338, 156337, 156336, 156335, 156334, 156333, 156332, 156331, 156330, 156329, 156328, 156327, 156326, 156325, 156324, 156323, 156322, 156321, 156320, 156319, 156318, 156317, 156316, 156315, 156314, 156313, 156312, 156311, 156310, 156309, 156308, 156307, 156306, 156305, 156304, 156303, 156302, 156301, 156300, 156299, 156298, 156297, 156296, 156295, 156294, 156293, 156292, 156291, 156290, 156289, 156754, 156753, 156752, 156751, 156750, 156749, 156748, 156747, 156746, 156745, 156744, 156743, 156742, 156741, 156740, 156739, 156738, 156737, 156736, 156735, 156734, 156733, 156732, 156731, 156730, 156729, 156728, 156727, 156726, 156725, 156724, 156723, 156722, 156721, 156720, 156719, 156718, 156717, 156716, 156715, 156714, 156713, 156288, 156287, 156286, 156285, 156284, 156283, 156282, 156281, 156280, 156279, 156278, 156277, 156276, 156275, 156274, 156273, 156272, 156271, 156270, 156269, 156268, 156267, 156266, 156265, 156264, 156263, 156237, 156236, 156235, 156234, 156233, 156232, 156231, 156230, 156229, 156228, 156227, 156226, 156225, 156224, 156223, 156222, 156221, 156220, 156219, 156218, 156217, 156216, 156215, 156214, 156213, 156212, 156211, 156210, 156209, 156208, 156207, 156206, 156205, 156204, 156203, 156202, 156201, 156200, 156199, 156198, 156197, 156196, 156195, 156194, 156193, 156192, 156191, 156190, 156189, 156188, 156187, 156186, 156185, 156184, 156183, 156182, 156181, 156180, 156179, 156178, 156177, 156176, 156175, 156174, 156173, 156172, 156171, 156170, 156169, 156168, 156167, 156166, 156165, 156164, 156163, 156162, 156161, 156160, 156159, 156158, 156157, 156156, 156155, 156154, 156153, 156152, 156151, 156150, 156149, 156148, 156147, 156146, 156145, 156144, 156143, 156142, 156141, 156140, 156139, 156138, 156137, 156136, 156135, 156134, 156133, 156132, 156131, 156130, 156129, 156128, 156127, 156126, 156125, 156124, 156123, 156122, 156121, 156120, 156119, 156118, 156117, 156116, 156115, 156114, 156113, 156112, 156111, 156110, 156109, 156108, 156107, 156106, 156105, 156104, 156103, 156102, 156101, 156100, 156099, 156098, 156097, 156096, 156095, 156094, 156093, 156092, 156091, 156496, 156495, 156494, 156493, 156492, 156491, 156490, 156489, 156488, 156487, 156486, 156485, 156484, 156483, 156482, 156481, 156480, 156479, 156262, 156261, 156260, 156259, 156258, 156257, 156256, 156255, 156254, 156253, 156252, 156251, 156250, 156249, 156248, 156247, 156246, 156245, 156244, 156243, 156242, 156241, 156240, 156239, 156238].include?(156092)
